name: Build 2

on:
  workflow_dispatch:

jobs:
  build:

    runs-on: ubuntu-latest

    env:
      UAT_REPO_NAME: uat-rail-map-generator

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '14'
      - run: npm ci

      - name: Build PRD
        run: |
          npm run build
          chmod -x ./build.sh
          ./build.sh
          echo "RMG_VER=$(node -p "require('./package.json').version")" >> $GITHUB_ENV

      - name: Copy PRD Artifacts
        run: |
          git clone --depth 1 https://wongchito:${{ secrets.ACCESS_TOKEN }}@github.com/wongchito/${{ env.UAT_REPO_NAME }}.git
          mkdir ${{ env.UAT_REPO_NAME }}/$RMG_VER/
          cp -r build/ ${{ env.UAT_REPO_NAME }}/$RMG_VER/PRD/

      - name: Build UAT and Copy Artifacts
        run: |
          echo "var pkg=require('./package.json'); pkg.homepage=\"https://wongchito.github.io/${{ env.UAT_REPO_NAME }}\"; console.log(JSON.stringify(pkg));" | node > package-new.json
          cp package-new.json package.json
          npm run build
          cp -r build/ ${{ env.UAT_REPO_NAME }}/$RMG_VER/UAT/

      - name: Upload Artifacts
        run: |
          cd ${{ env.UAT_REPO_NAME }}/
          git add .
          git commit -m "Build RMG version $RMG_VER"
          git push
